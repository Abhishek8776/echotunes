{% extends 'user/user_index.html' %}
{% block user_index %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
<form action="." method="post">
  <div class="row">
    {% csrf_token %}
    <div class="col-8 p-2">
      {% if user.is_authenticated %}
      <div class="border shadow mb-2 p-3">
        <div class="h6 text-body-secondaryry"><span class="badge bg-secondary">1</span> LOGIN</div>
        <div class="h6">{{ user.name }} - {{ user.email }}</div>
      </div>
      {% endif %}
      <div class="border shadow mb-2 p-3">
        <div class="h6 text-body-secondaryry"><span class="badge bg-secondary">2</span> DELIVERY ADDRESS</div>
        <div class="border mb-2 p-2">
          <div class="form-check d-flex justify-content-between">
            <div id="selectedaddress"></div>
            <div class="d-flex">
              <button class="btn btn-primary fw-semibold my-auto" data-bs-toggle="modal" data-bs-target="#add_address" type="button">Change Address</button>
            </div>
            <div class="modal fade" id="add_address" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Change Address</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body p-2">
                    {% for address in addresses %}
                    <div class="form-check border mb-2">
                      <div class="p-2">
                        <input class="form-check-input" type="radio" name="address" value="{{ address.id }}" id="address{{ forloop.counter }}" {% if forloop.counter == 1 %}checked{% endif %}>
                        <label class="form-check-label" for="address{{ forloop.counter }}">
                          <div>{{ address.gender }}. {{ address.name }} - {{ address.mobile }}</div>
                          <div>{{ address.address }}</div>
                          <div>{{ address.place }} - {{ address.pincode }}</div>
                        </label>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" value="Save" onclick="updateaddress()" data-bs-dismiss="modal">Select </button>
                  </div>
                </div>
              </div> 
            </div> 
          </div>
        </div>
      </div>
      <div class="border shadow mb-2 p-3">
        <div class="h6 text-body-secondaryry"><span class="badge bg-secondary">3</span> ORDER SUMMERY</div>
        {% for item in cart_items %}
        <div class="row mb-2 p-2 border">

          <div class="col-2">
            {% comment %} <a href="{% url 'user_product_details' item.product_variant.id %}"> {% endcomment %}
              <img src="{{ item.product_variant.cover_image.url }}" class="img-fluid bg-secondary-subtle border rounded-3" alt="product"/>
            {% comment %} </a> {% endcomment %}
          </div>

          <div class="col-10">
            <div class="d-flex justify-content-between">
              <h4 class="fw-bold">{{ item.product_variant.product.brand }} {{ item.product_variant.product.name }}</h4>
              <a class="h4 text-danger" href="{% url 'remove_cart_item' item.product_variant.id %}"><i class="bi bi-trash"></i></a>        
            </div>
            <div>
              <h6 class="text-secondary">{{ item.product_variant.product.description }}</h6>
            </div>
            <div>
              <span class="fw-medium h4">₹{{ item.product_variant.selling_price }} </span>
              <span class="fw-bold text-decoration-line-through text-secondary h5">₹{{ item.product_variant.actual_price }}</span>
              <span class=" text-success fw-bold">{{ item.product_variant.discount_percentage }}% off</span>        
            </div>
            <div class="d-flex align-items-center gap-2 pt-2">
              {% if item.count > 1 %}
              <a class="text-decoration-none text-body-tertiary" href="{% url 'subtract_cart_item_count' item.product_variant.id %}">
              <i class="bi bi-dash-circle-fill h5"></i></a>
              {% else %}
              <a href=""><i class="bi bi-dash-circle-fill text-body-tertiary h5"></i></a>
              {% endif %}
              <div class=" border border-2 border-secondary-subtle rounded-0  px-2">{{ item.count }}</div>
              <a class="text-decoration-none text-body-tertiary" href="{% url 'add_cart_item_count' item.product_variant.id %}" ><i class="bi bi-plus-circle-fill h5"></i></a>
            </div> 
          </div>
        </div> 
        {% endfor %}
      </div>
      <div class="border shadow mb-2 p-3">
        <div class="h6 text-body-secondaryry"><span class="badge bg-secondary">3</span> PAYMENT OPTIONS</div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="payment_method" value="cod" id="cod" checked>
            <label class="form-check-label" for="cod">
              Cash On Delivery
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="payment_method" value="online" id="online">
            <label class="form-check-label" for="online">
              Online Payment  
            </label>
          </div>
      </div>
    </div>

    <div class="col-4 p-2">
      <div class="p-3 border">
        <div class="h5 ">PRICE DETAILS</div>
        <hr>
        <div class="row">
          <div class="col h6 text-secondary">Price ({{ cart.total_count }} items)</div>
          <div class="col h6 text-secondary">₹{{ cart.total_actual_price }}</div>
        </div>
        <div class="row">
          <div class="col h6 text-secondary">Discount</div>
          <div class="col text-success h6">-₹{{ cart.total_discount_price }}</div>
        </div>
        <div class="row">
          <div class="col h6 text-secondary">Coupon Discount</div>
          <div class="col h6 text-secondary">0</div>
        </div>
        <div class="row">
          <div class="col h6 text-secondary">Delivery Charges</div>
          <div class="col h6 text-secondary text-success">FREE</div>
        </div>
        <hr>
        <div class="row">
          <div class="col h6">Total Amount</div>
          <div class="col h6">₹{{ cart.total_selling_price }}</div>
        </div>
        <hr>
        <div class="d-grid py-2">
          <input class="btn btn-primary d-none" id="rzp-button1" type="submit" value="CONFIRM ORDER1">
          <input class="btn btn-primary d-block" id="cod-button1" type="submit" value="CONFIRM ORDER2">
        </div>
      </div>
    </div>
  </div>
</form>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>

  function updateaddress(){
    const selectedradio = document.querySelector("input[name='address']:checked");
    const radiolabrl = selectedradio.parentElement.querySelector("label");
    const selectedaddress = document.getElementById('selectedaddress')
    selectedaddress.innerHTML = radiolabrl.innerHTML;
  }
  
  document.addEventListener("DOMContentLoaded", function () {
    const initiallyCheckedRadio = document.querySelector("input[name='address']:checked");
    if (initiallyCheckedRadio) {
      const radiolabel = initiallyCheckedRadio.parentElement.querySelector("label");
      const selectedaddress = document.getElementById('selectedaddress');
      selectedaddress.innerHTML = radiolabel.innerHTML;
    }
  });

  const codRadio = document.getElementById("cod");
  const onlineRadio = document.getElementById("online");
  const rzpButton = document.getElementById("rzp-button1");
  const codButton = document.getElementById("cod-button1");

  codRadio.addEventListener("change", () => {
      rzpButton.classList.add("d-none");
      codButton.classList.remove("d-none");
  });

  onlineRadio.addEventListener("change", () => {
      codButton.classList.add("d-none");
      rzpButton.classList.remove("d-none");
  });
</script>
<script>
  var options = {
    "key": "rzp_test_GymqhlzDIArQCb", 
    "amount": "{{ cart.total_selling_price }}00",
    "currency": "INR",
    "name": "EchoTunes",
    "description": "Test Transaction",
    "image": "https://example.com/your_logo",
    "order_id": "{{ payment.id }}", 
    "handler": function (response){
        alert(response.razorpay_payment_id);
        alert(response.razorpay_order_id);
        alert(response.razorpay_signature);
    },
    "theme": {
      "color": "#3399cc"
    }
  };
  var rzp1 = new Razorpay(options);
  rzp1.on('payment.failed', function (response){
    alert(response.error.code);
    alert(response.error.description);
    alert(response.error.source);
    alert(response.error.step);
    alert(response.error.reason);
    alert(response.error.metadata.order_id);
    alert(response.error.metadata.payment_id);
  });
  document.getElementById('rzp-button1').onclick = function(e){
    rzp1.open();
    e.preventDefault();
  }
</script> 


{% endblock user_index %}